name: Build RaisingBot

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest
      - name: Run tests
        run: python -m pytest tests/ -v

  build-mac:
    runs-on: macos-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: List files
        run: ls -R
      - name: Build frontend
        run: |
          cd raising-bot-web
          npm install
          npm run build
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build with PyInstaller
        run: |
          pyinstaller RaisingBot.spec
      - name: Rename app to include version
        run: |
          cd dist
          mv RaisingBot.app RaisingBot-${{ github.ref_name }}.app
      - name: Zip macOS artifact
        run: |
          cd dist
          zip -r RaisingBot-mac-${{ github.ref_name }}.zip RaisingBot-${{ github.ref_name }}.app
      - name: Upload ZIP to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/RaisingBot-mac-${{ github.ref_name }}.zip

  build-windows:
    runs-on: windows-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: List files
        run: ls -R
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Build frontend
        run: |
          cd raising-bot-web
          npm install
          npm run build
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build with PyInstaller
        run: |
          pyinstaller RaisingBot.spec
      - name: Rename app folder to include version
        run: |
          cd dist
          mv RaisingBot RaisingBot-${{ github.ref_name }}
      - name: Rename EXE to include version
        run: |
          cd dist/RaisingBot-${{ github.ref_name }}
          mv RaisingBot.exe RaisingBot-${{ github.ref_name }}.exe
      - name: Zip Windows artifact
        run: |
          cd dist
          powershell Compress-Archive -Path RaisingBot-${{ github.ref_name }} -DestinationPath RaisingBot-windows-${{ github.ref_name }}.zip
      - name: Upload artifact for testing
        uses: actions/upload-artifact@v4
        with:
          name: RaisingBot-windows
          path: dist/
      - name: Upload ZIP to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/RaisingBot-windows-${{ github.ref_name }}.zip

  test-windows:
    runs-on: windows-latest
    needs: build-windows
    steps:
      - uses: actions/checkout@v4
      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: RaisingBot-windows
          path: .
      - name: List files
        run: dir
      - name: Run EXE and show log
        run: |
          Start-Job -ScriptBlock { .\RaisingBot-${{ github.ref_name }}\RaisingBot-${{ github.ref_name }}.exe }
          Start-Sleep -Seconds 15
          curl http://127.0.0.1:9527/api/status
          Get-Job | Remove-Job -Force